# GitHub Actions workflow for testing DVMHost installation on Raspberry Pi OS 64-bit
# Uses QEMU emulation to run ARM64 Raspberry Pi OS in GitHub Actions

name: Test Installation on Raspberry Pi OS

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  test-install-arm64:
    name: Test on Raspberry Pi OS 64-bit (ARM64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Test installation in Raspberry Pi OS container
        uses: pguyot/arm-runner-action@v2
        with:
          # Use official Raspberry Pi OS 64-bit lite image
          base_image: raspios_lite_arm64:latest
          # Bind the repository to /repo in the emulated environment
          bind_mount_repository: true
          # Commands to run inside the Raspberry Pi OS environment
          commands: |
            # Verify we're running on Raspberry Pi OS
            echo "========================================"
            echo "Verifying Raspberry Pi OS Environment"
            echo "========================================"
            cat /etc/os-release
            echo ""
            uname -a
            echo ""

            # Update system
            apt-get update

            # The repository is mounted at /hotspot-installer (repo name)
            chmod +x /hotspot-installer/install.sh

            # Run installation (skip netbird and services for CI testing)
            # Platform check should PASS since we're on real Raspberry Pi OS
            /hotspot-installer/install.sh --skip-netbird --skip-services

            # Verify the build was successful
            echo "Verifying installation..."

            # Check that dvmhost binary exists and is executable
            if [ -f /opt/centrunk/dvmhost/dvmhost ]; then
              echo "✓ dvmhost binary found"
              ls -la /opt/centrunk/dvmhost/dvmhost
            else
              echo "✗ dvmhost binary not found!"
              exit 1
            fi

            # Check that the binary is the correct architecture
            file /opt/centrunk/dvmhost/dvmhost

            # Check directory structure
            echo "Checking directory structure..."
            [ -d /var/log/centrunk ] && echo "✓ /var/log/centrunk exists" || exit 1
            [ -d /opt/centrunk ] && echo "✓ /opt/centrunk exists" || exit 1
            [ -d /opt/centrunk/configs ] && echo "✓ /opt/centrunk/configs exists" || exit 1
            [ -d /opt/centrunk/dvmhost ] && echo "✓ /opt/centrunk/dvmhost exists" || exit 1

            # Verify binary is executable
            echo "Checking binary is executable..."
            [ -x /opt/centrunk/dvmhost/dvmhost ] && echo "✓ dvmhost is executable" || exit 1

            # Verify binary runs (show help or version)
            echo "Testing binary execution..."
            if /opt/centrunk/dvmhost/dvmhost -h 2>&1 | head -5; then
              echo "✓ dvmhost binary executes successfully"
            else
              echo "Note: dvmhost may require config to show help"
            fi

            # Verify systemd service files were copied correctly
            echo "Verifying systemd service files in repo..."
            [ -f /hotspot-installer/systemd/centrunk.cc.service ] && echo "✓ CC service file exists in repo" || exit 1
            [ -f /hotspot-installer/systemd/centrunk.vc.service ] && echo "✓ VC service file exists in repo" || exit 1

            echo ""
            echo "=========================================="
            echo "All installation tests passed successfully!"
            echo "=========================================="

  test-syntax:
    name: Shell Script Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Check install.sh syntax
        run: shellcheck install.sh

      - name: Validate systemd service files
        run: |
          for service in systemd/*.service; do
            echo "Checking $service..."
            # Basic syntax validation
            if grep -q "\[Unit\]" "$service" && \
               grep -q "\[Service\]" "$service" && \
               grep -q "\[Install\]" "$service"; then
              echo "✓ $service has valid structure"
            else
              echo "✗ $service is missing required sections"
              exit 1
            fi
          done
          echo "All service files validated!"

  test-install-x86:
    name: Test Script Logic (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test directory creation and script logic
        run: |
          # Test the script can be sourced and functions work
          # (without actually running the full installation)

          # Create mock environment
          sudo mkdir -p /var/log/centrunk
          sudo mkdir -p /opt/centrunk/configs

          # Test script is valid bash
          bash -n install.sh
          echo "✓ Script syntax is valid"

          # Test help flag
          chmod +x install.sh
          ./install.sh --help
          echo "✓ Help flag works"

          echo "Script logic tests passed!"

  # Discord notification on success or failure
  notify-discord:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [test-install-arm64, test-syntax, test-install-x86]
    if: always()

    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_SUCCESS: ${{ secrets.DISCORD_WEBHOOK_SUCCESS }}
          DISCORD_WEBHOOK_FAILURE: ${{ secrets.DISCORD_WEBHOOK_FAILURE }}
          ARM64_RESULT: ${{ needs.test-install-arm64.result }}
          SYNTAX_RESULT: ${{ needs.test-syntax.result }}
          X86_RESULT: ${{ needs.test-install-x86.result }}
        run: |
          # Determine overall status and webhook
          if [[ "$ARM64_RESULT" == "success" && "$SYNTAX_RESULT" == "success" && "$X86_RESULT" == "success" ]]; then
            STATUS="success"
            TITLE="✅ CI/CD Pipeline Passed"
            DESCRIPTION="All tests passed successfully!"
            COLOR=3066993
            WEBHOOK="$DISCORD_WEBHOOK_SUCCESS"
          else
            STATUS="failure"
            TITLE="❌ CI/CD Pipeline Failed"
            DESCRIPTION="One or more tests failed."
            COLOR=15158332
            WEBHOOK="$DISCORD_WEBHOOK_FAILURE"
          fi

          # Skip if no webhook configured
          if [[ -z "$WEBHOOK" ]]; then
            echo "No webhook configured for $STATUS notifications, skipping"
            exit 0
          fi

          # Build job status field
          get_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              cancelled) echo "⚪" ;;
              skipped) echo "⏭️" ;;
              *) echo "❓" ;;
            esac
          }

          JOB_STATUS="$(get_emoji "$ARM64_RESULT") ARM64: $ARM64_RESULT\n$(get_emoji "$SYNTAX_RESULT") Syntax: $SYNTAX_RESULT\n$(get_emoji "$X86_RESULT") x86: $X86_RESULT"

          curl -H "Content-Type: application/json" \
            -d "{
              \"username\": \"GitHub Actions\",
              \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                  {\"name\": \"Job Results\", \"value\": \"$JOB_STATUS\", \"inline\": true},
                  {\"name\": \"Run\", \"value\": \"[View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$WEBHOOK"
